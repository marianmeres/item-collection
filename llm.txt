# @marianmeres/item-collection - LLM Context Document

## Package Overview

**Name:** @marianmeres/item-collection
**Version:** 1.3.1
**Author:** Marian Meres
**License:** MIT
**Repository:** https://github.com/marianmeres/item-collection

A high-performance TypeScript utility class for managing ordered collections of items with advanced features including active item tracking, tagging system, O(1) lookups, full-text search, reactive subscriptions, and serialization support.

## Runtime & Build

- **Primary Runtime:** Deno
- **Secondary Distribution:** npm (built from Deno source)
- **Entry Point:** src/mod.ts (re-exports from src/item-collection.ts)
- **Build System:** deno task npm:build (uses scripts/build-npm.ts)
- **Test Command:** deno test --watch

## Dependencies

- @marianmeres/pubsub (jsr:@marianmeres/pubsub@^2.4.1) - PubSub for reactive subscriptions
- @marianmeres/searchable (jsr:@marianmeres/searchable@^2.3.1) - Full-text search integration
- @std/assert - Testing assertions
- @std/fs - File system utilities (build scripts)
- @std/path - Path utilities (build scripts)

## File Structure

```
src/
  mod.ts              # Main export file
  item-collection.ts  # Core ItemCollection class (~1400 lines)
tests/
  item-collection.test.ts  # Comprehensive test suite
scripts/
  build-npm.ts        # npm package build script
API.md                # Complete API documentation
README.md             # User documentation
```

## Core Class: ItemCollection<T extends Item>

Generic collection class where T must extend `Record<string, any>`.

### Key Design Patterns

1. **Private Fields:** Uses TypeScript private class fields (#) for encapsulation
2. **Immutable Public Access:** getters return shallow copies to prevent external mutation
3. **Publish Control:** Most mutating methods accept a `publish` parameter to control reactivity
4. **Method Chaining:** Many methods return `this` for chaining
5. **Index-Based Lookups:** Maintains property-value indexes for O(1) lookups

### Constructor Options (ItemCollectionConfig<T>)

```typescript
{
  cardinality: number;              // Max items (default: Infinity)
  unique: boolean;                  // Prevent duplicates by id (default: true)
  idPropName: string;               // ID property name (default: "id")
  allowNextPrevCycle: boolean;      // Wrap navigation (default: false)
  allowUnconfiguredTags: boolean;   // Allow ad-hoc tags (default: true)
  tags: Record<string, { cardinality: number }>;  // Pre-configured tags
  sortFn: ((a: T, b: T) => number) | undefined;   // Auto-sort function
  normalizeFn: ((item: any) => T) | undefined;    // Item transform function
  searchable: ItemCollectionSearchableOptions<T> | undefined;  // Search config
}
```

### Properties (Read-only)

- `size: number` - Item count
- `items: T[]` - Shallow copy of all items
- `active: T | undefined` - Currently active item
- `activeIndex: number | undefined` - Index of active item
- `isFull: boolean` - True if cardinality reached
- `config: ExposedConfig` - Current configuration
- `idPropName: string` - Configured ID property name
- `searchable: Searchable | undefined` - Searchable instance if configured

### Collection Management Methods

- `add(item, autoSort?, publish?): boolean` - Add single item
- `addMany(items, publish?): number` - Add multiple items, returns count added
- `remove(item, publish?): boolean` - Remove by item reference (matched by id)
- `removeAt(index, publish?): boolean` - Remove by index
- `removeAllBy(property, value, publish?): number` - Remove all matching property/value
- `toggleAdd(item, publish?): boolean` - Add if absent, remove if present
- `patch(item, publish?): boolean` - Update existing item in-place by id
- `patchMany(items, publish?): number` - Update multiple items
- `move(fromIndex, toIndex, publish?): boolean` - Reorder item
- `clear(publish?): ItemCollection<T>` - Remove all items
- `sort(sortFn?, publish?): boolean` - Re-sort collection
- `at(index): T | undefined` - Get item by index (supports negative indexing)
- `getAll(): T[]` - Get all items as shallow copy
- `configure(options, publish?): ItemCollection<T>` - Update configuration

### Active Item Navigation

- `setActive(item, publish?): boolean` - Set active by item (matched by id)
- `setActiveIndex(index, publish?): T | undefined` - Set active by index
- `unsetActive(publish?): ItemCollection<T>` - Clear active item
- `setActiveNext(): T | undefined` - Move to next item
- `setActivePrevious(): T | undefined` - Move to previous item
- `setActiveFirst(): T | undefined` - Move to first item
- `setActiveLast(): T | undefined` - Move to last item

### Lookups (O(1) via property indexing)

- `exists(idOrItem): boolean` - Check if item exists
- `findById(id): T | undefined` - Find by ID
- `findBy(property, value): T | undefined` - Find first by property/value
- `findAllBy(property, value): T[]` - Find all by property/value
- `findIndexBy(property, value): number` - Find first index (-1 if not found)
- `findAllIndexesBy(property, value): number[]` - Find all indexes
- `search(query, strategy?, options?): T[]` - Full-text search (requires searchable config)

### Tagging System

- `configureTag(tagName, config?, publish?): boolean` - Configure tag with cardinality
- `applyTag(item, tagName, publish?): boolean` - Apply tag to item
- `applyTagByIndex(index, tagName, publish?): boolean` - Apply tag by index
- `applyTagByIndexes(indexes, tagName, publish?): boolean` - Apply tag to multiple
- `removeTag(item, tagName, publish?): boolean` - Remove tag from item
- `removeTagByIndex(index, tagName, publish?): boolean` - Remove tag by index
- `removeTagByIndexes(indexes, tagName, publish?): boolean` - Remove from multiple
- `hasTag(item, tagName): boolean` - Check if item has tag
- `hasTagByIndex(index, tagName): boolean` - Check by index
- `getByTag(tagName): T[]` - Get all items with tag
- `getIndexesByTag(tagName): number[]` - Get indexes with tag
- `toggleTag(item, tagName, publish?): boolean` - Toggle tag (returns true if applied)
- `toggleTagByIndex(index, tagName, publish?): boolean | undefined` - Toggle by index
- `deleteTag(tagName, publish?): boolean` - Delete tag completely

### Serialization

- `toJSON(): ItemCollectionDump<T>` - Export to serializable object
- `dump(): string` - Serialize to JSON string
- `restore(dump): boolean` - Restore from dump (string or object)
- `static fromJSON<T>(json): ItemCollection<T>` - Create instance from JSON

### Reactivity

- `subscribe(cb): () => void` - Subscribe to changes, returns unsubscribe function
  - Callback receives: `{ items, active, activeIndex, size, isFull, config, timestamp, lastQuery }`
  - Immediately invoked with current state on subscription

## TypeScript Interfaces

```typescript
interface Item extends Record<string, any> {}

interface ItemCollectionDump<T> {
  items: T[];
  activeIndex: number | undefined;
  cardinality: number;
  unique: boolean;
  idPropName: string;
  tags: Record<string, number[]>;
  tagConfigs: Record<string, { cardinality: number }>;
}

interface ItemCollectionSearchableOptions<T> extends Partial<SearchableOptions> {
  getContent: (item: T) => string | undefined;
}

interface ExposedConfig {
  cardinality: number;
  tags: Record<string, { cardinality: number }>;
  allowNextPrevCycle: boolean;
  allowUnconfiguredTags: boolean;
  unique: boolean;
  idPropName: string;
}
```

## Internal Implementation Details

1. **Property Indexing:** `#indexesByProperty: Map<string, Map<any, number[]>>` maintains indexes for O(1) lookups
2. **Tag Storage:** `#tags: Map<string, Set<number>>` maps tag names to sets of item indexes
3. **Reactivity:** Uses @marianmeres/pubsub internally via `#pubsub: PubSub`
4. **Index Maintenance:** Indexes are rebuilt on remove/move operations for safety
5. **Searchable Integration:** When configured, maintains searchable index alongside collection
6. **Normalization:** Default normalizeFn converts strings to `{ [idPropName]: string }`

## Common Use Cases

1. **Selection Management:** Use tags with cardinality for multi-select (Infinity) or single-select (1)
2. **Keyboard Navigation:** Use active tracking with allowNextPrevCycle
3. **Searchable Lists:** Configure searchable with getContent function
4. **Tab Management:** Use active item for current tab, tags for pinned/closed states
5. **Persistence:** Use dump/restore for localStorage or sessionStorage

## Testing Patterns

Tests use Deno.test with @std/assert. Helper function `createAbc()` creates test collection with items `[{id:"a"},{id:"b"},{id:"c"}]`. Tests cover: sanity checks, toggle operations, uniqueness, add/remove, active navigation, cardinality, tagging (including cardinality, indexes, move/remove adjustments), custom idPropName, searchable, sortFn, normalizeFn, patch, and subscription behavior.

## Code Style

- Uses tabs for indentation
- Line width: 90 characters
- Indent width: 4
- Configured in deno.json fmt section

## Version History Note

Current version 1.3.1 - Package is stable and well-documented with comprehensive API.md file available for detailed method documentation.
